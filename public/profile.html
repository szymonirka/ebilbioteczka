<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Moje konto</title>
</head>
<body>
<h1>üë§ Panel u≈ºytkownika</h1>

<h2>üíñ Moje ulubione ksiƒÖ≈ºki</h2>
<ul id="favorites_list"></ul>

<h2> Zmie≈Ñ has≈Ço </h2>
<input type="password" id = "new_password" placeholder="Nowe has≈Ço">
<button onclick="changePassword()">Zmie≈Ñ has≈Ço</button>

<h2>‚úèÔ∏è Zmie≈Ñ nazwƒô u≈ºytkownika</h2>
<input type="text" id="new_username" placeholder="Nowa nazwa u≈ºytkownika">
<button onclick="changeUsername()">Zmie≈Ñ nazwƒô</button>
<h2>‚ùå Usu≈Ñ konto</h2>

<button onclick="deleteAccount()"> Usu≈Ñ moje konto</button>

<p><a href="index.html">‚Üê Powr√≥t</a></p>

<script>
    const token = localStorage.getItem('token');

    if (!token) {
        alert("Musisz byƒá zalogowany.");
        window.location.href = "index.html";
    }

    async function loadFavorites() {
        try {
            const res = await fetch('/api/favorites', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            const books = await res.json();
            const list = document.getElementById('favorites_list');
            list.innerHTML = '';

            books.forEach(book => {
                const li = document.createElement('li');
                li.innerHTML = `
                        <a href="book.html?id=${book.id}">${book.title}</a> ‚Äì ${book.author}
                        <button onclick="removeFavorite(${book.id})">‚ùå Usu≈Ñ</button>
                    `;
                list.appendChild(li);
            });

        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd pobierania ulubionych ksiƒÖ≈ºek.");
        }
    }

    async function removeFavorite(bookId) {
        try {
            const res = await fetch(`/api/favorites/${bookId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            const data = await res.json();
            alert(data.message);
            loadFavorites();
        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd usuwania z ulubionych.");
        }
    }

    async function changePassword() {
        const newPassword = document.getElementById('new_password').value;
        if (!newPassword) return alert("Wprowad≈∫ nowe has≈Ço");

        try {
            const res = await fetch('/api/users/change-password', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ newPassword })
            });
            const data = await res.json();
            alert(data.message);
        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd zmiany has≈Ça.");
        }
    }

    async function deleteAccount() {
        if (!confirm("Czy na pewno chcesz usunƒÖƒá konto?")) return;

        try {
            const res = await fetch('/api/users/delete', {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            const data = await res.json();
            alert(data.message);
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd usuwania konta.");
        }
    }
    async function changeUsername() {
        const newUsername = document.getElementById('new_username').value;
        if (!newUsername) return alert("Wpisz nowƒÖ nazwƒô u≈ºytkownika");

        try {
            const res = await fetch('/api/users/change-username', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ newUsername })
            });

            const data = await res.json();
            alert(data.message);
            if (res.ok) {
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            }
        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd przy zmianie nazwy u≈ºytkownika.");
        }
    }


    window.addEventListener('DOMContentLoaded', loadFavorites);
</script>
</body>
</html>