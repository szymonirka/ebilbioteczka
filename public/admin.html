<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel Administratora</title>
</head>
<body>
<h1>ğŸ‘‘ Panel Administratora</h1>

<div id="admin_status"></div>

<section>
  <h2>ğŸ“š ZarzÄ…dzanie ksiÄ…Å¼kami</h2>
  <input type="text" id="book_title" placeholder="TytuÅ‚">
  <input type="text" id="book_author" placeholder="Autor">
  <textarea id="book_content" placeholder="TreÅ›Ä‡ ksiÄ…Å¼ki"></textarea>
  <button onclick="addBook()">Dodaj ksiÄ…Å¼kÄ™</button>

  <h3>ğŸ“– IstniejÄ…ce ksiÄ…Å¼ki:</h3>
  <ul id="book_list"></ul>
</section>

<hr>

<section>
  <h2>ğŸ‘¥ ZarzÄ…dzanie isniejÄ…cymi uÅ¼ytkownikami</h2>
  <ul id="user_list"></ul>
</section>

<h2>â• Dodaj uÅ¼ytkownika</h2>
<input type="text" id="new_user_username" placeholder="Nazwa uÅ¼ytkownika">
<input type="password" id="new_user_password" placeholder="HasÅ‚o">
<input type="password" id="new_user_confirm_password" placeholder="PotwierdÅº hasÅ‚o">
<select id="new_user_role">
  <option value="user">UÅ¼ytkownik</option>
  <option value="admin">Administrator</option>
</select>
<button onclick="createUser()">Dodaj uÅ¼ytkownika</button>


<p><a href="index.html">â† PowrÃ³t do strony gÅ‚Ã³wnej</a></p>

<script>
  const token = localStorage.getItem('token');
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  };

  // SprawdÅº rolÄ™
  function checkAdmin() {
    if (!token) {
      alert("Brak dostÄ™pu â€“ zaloguj siÄ™ jako administrator.");
      window.location.href = "index.html";
      return;
    }

    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload.role !== 'admin') {
      alert("DostÄ™p tylko dla administratorÃ³w.");
      window.location.href = "index.html";
    } else {
      document.getElementById('admin_status').textContent = `Zalogowany jako: ${payload.username} (admin)`;
    }
  }

  // KsiÄ…Å¼ki
  async function loadBooks() {
    const res = await fetch('/api/books');
    const books = await res.json();
    const list = document.getElementById('book_list');
    list.innerHTML = '';

    books.forEach(book => {
      const li = document.createElement('li');
      li.innerHTML = `
                    <strong>${book.title}</strong> â€“ ${book.author}
                    <button onclick="deleteBook(${book.id})">ğŸ—‘ï¸ UsuÅ„</button>
                `;
      list.appendChild(li);
    });
  }

  async function addBook() {
    const title = document.getElementById('book_title').value;
    const author = document.getElementById('book_author').value;
    const content = document.getElementById('book_content').value;

    const res = await fetch('/api/admin/books', {
      method: 'POST',
      headers,
      body: JSON.stringify({ title, author, content })
    });

    const data = await res.json();
    alert(data.message || "KsiÄ…Å¼ka dodana");
    loadBooks();
  }

  async function deleteBook(id) {
    if (!confirm("Na pewno usunÄ…Ä‡ ksiÄ…Å¼kÄ™?")) return;
    const res = await fetch(`/api/admin/books/${id}`, {
      method: 'DELETE',
      headers
    });
    const data = await res.json();
    alert(data.message || "UsuniÄ™to ksiÄ…Å¼kÄ™");
    loadBooks();
  }

  // UÅ¼ytkownicy
  async function loadUsers() {
    const res = await fetch('/api/admin/users', {
      headers
    });

    const users = await res.json();
    const list = document.getElementById('user_list');
    list.innerHTML = '';

    users.forEach(user => {
      const li = document.createElement('li');
      li.innerHTML = `
                    <strong>${user.username}</strong> â€“ ${user.role}
                    <button onclick="deleteUser(${user.id})">ğŸ—‘ï¸ UsuÅ„</button>
                `;
      list.appendChild(li);
    });
  }

  async function deleteUser(id) {
    if (!confirm("UsunÄ…Ä‡ uÅ¼ytkownika?")) return;

    const res = await fetch(`/api/admin/users/${id}`, {
      method: 'DELETE',
      headers
    });

    const data = await res.json();
    alert(data.message || "UÅ¼ytkownik usuniÄ™ty");
    loadUsers();
  }
  async function createUser() {
    const username = document.getElementById('new_user_username').value.trim();
    const password = document.getElementById('new_user_password').value;
    const confirmPassword = document.getElementById('new_user_confirm_password').value;
    const role = document.getElementById('new_user_role').value;

    if (!username || !password || !confirmPassword) {
      return alert('WprowadÅº wszystkie dane.');
    }

    if (password !== confirmPassword) {
      return alert('âŒ HasÅ‚a nie sÄ… takie same!');
    }

    try {
      const res = await fetch('/api/admin/users/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ username, password, role })
      });

      const data = await res.json();
      alert(data.message);

      // Czyszczenie formularza po sukcesie
      document.getElementById('new_user_username').value = '';
      document.getElementById('new_user_password').value = '';
      document.getElementById('new_user_confirm_password').value = '';
      document.getElementById('new_user_role').value = 'user';

      loadUsers(); // odÅ›wieÅ¼ listÄ™ uÅ¼ytkownikÃ³w
    } catch (err) {
      console.error(err);
      alert('âŒ BÅ‚Ä…d podczas dodawania uÅ¼ytkownika.');
    }
  }


  window.addEventListener('DOMContentLoaded', () => {
    checkAdmin();
    loadBooks();
    loadUsers();
  });
</script>
</body>
</html>
